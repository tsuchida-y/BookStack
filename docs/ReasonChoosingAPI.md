# 書籍データAPI選定理由書

## 1. 本アプリにおける「書籍データAPI」の役割

BookStackのコア機能である「背表紙の厚み表現」と「本棚の美しさ」を実現するため、以下の要件からAPIを選定する。

1.  **書誌情報の特定 (Identification)**
    * ISBNコードから間違いなくその本を特定する。
2.  **ビジュアルの提供 (Visualization)**
    * **高画質な書影（表紙画像）:** ユーザーが「眺めていたくなる」クオリティが必要。
    * **色抽出の元データ:** 疑似背表紙を作るための「ドミナントカラー抽出」に耐えうる画質。
3.  **物理情報の提供 (Dimension)**
    * **ページ数（Page Count）:** 本の「厚み」を計算するために必須。ここが欠落しているAPIだと、背表紙生成ロジックが破綻する。
    * **本の分類コード（Cコード）:** 発行形態（文庫、新書、単行本など）を判定するために有用。 
        * 本の高さをよりリアルに再現するための参考情報としても有用。
        * ページ数が欠損している場合の補完手段としても活用可能。

---

## 2. 書籍データAPIの候補と比較

### A. OpenBD (オープン・ビー・ディー)
* **特徴:** 版元ドットコムなどのデータを元にした、国内最速のAPI。
* **メリット:**
    * **爆速:** レスポンスが非常に速い。
    * **登録不要:** APIキー不要で即実装可能。
    * **画質が良い:** 出版社提供のキレイな書影が多い。
* **デメリット:**
    * **古い本に弱い:** 近年の本は強いが、古書はヒットしないことがある。
    * **ページ数の欠損:** データ元によりページ数が入っていない場合がある。

### B. Google Books API
* **特徴:** 世界最大級の書籍データベース。
* **メリット:**
    * **網羅性:** 洋書、技術書、古い本など、OpenBDで出ない本も大抵ヒットする。
    * **ページ数:** 比較的高い確率でページ数データを持っている。
* **デメリット:**
    * **画質が不安定:** 画像サイズが小さい（サムネイル）場合がある。
    * **書影なし:** データはあるが画像がない（No Image）ケースがある。
    * **利用制限:** 大量のリクエストにはAPIキーと制限（Quota）への配慮が必要。

### C. 楽天ブックス書籍検索API
* **特徴:** ECサイト「楽天ブックス」のデータ。
* **メリット:** 商業出版に強く、画像が安定して存在する。
* **デメリット:** **APIのレスポンスに「ページ数」が含まれていないことが多い。** 今回の「厚み表現」要件とは相性が悪いため**不採用**。

### D. 国立国会図書館サーチ API (NDL Biblio)
* **特徴:** 国内出版物の網羅性は最強。
* **メリット:** 同人誌等を除きほぼ全ての本がある。
* **デメリット:** 書影データ自体を持たない（Amazon等へのリンクのみ）。レスポンスが複雑。

---

## 3. 比較マトリクス

| API名 | 日本書籍の網羅性 | 書影(画質) | ページ数データ | 導入難易度 | 評価 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **OpenBD** | △ (新刊◎ 古書✕) | ◎ (高画質) | △ (欠損あり) | ◎ (登録不要) | **メイン採用** |
| **Google Books** | ◎ (洋書も可) | △ (画質ムラ) | ◯ (比較的ある) | ◯ (API Key) | **サブ採用** |
| **楽天ブックス** | ◯ | ◯ | **✕ (基本なし)** | ◯ (ID必要) | **不採用** |
| **国立国会図書館** | ◎ (最強) | ✕ (なし) | △ (表記揺れ) | △ (XML解析) | **対象外** |

---

## 4. 推奨する実装戦略：ハイブリッド取得フロー

単一のAPIでは要件（画質＋ページ数＋網羅性）を満たせないため、以下の戦略でデータを統合する。

### 4-1. データ取得の優先順位（Repositoryパターン）

1.  **OpenBD (Primary):** 高画質な書影とCコード取得のため最優先で使用。
2.  **Google Books (Secondary):** OpenBDでヒットしない古書・洋書や、ページ数情報の補完として使用。
3.  **Fallback:** 両APIでページ数が不明な場合、アプリ側でデフォルト値（例: 200p）を設定し、ユーザー入力を促す。

### 4-2. Cコードを活用した「高さ」の再現ロジック

本棚のリアリティ（凸凹感）を出すため、OpenBD等から取得可能な**「Cコード（日本図書コード）」の2桁目（発行形態）**を活用してサイズを判定する。

**【サイズ判定フロー】**

1.  **Cコードによる一次判定（高精度）**

    | Cコード(2桁目) | 主な分類 | アプリサイズ判定 | 高さ倍率 | 備考 |
    | :---: | :--- | :---: | :---: | :--- |
    | **1** | 文庫 | **S** | 1.00 | 基準サイズ |
    | **2** | 新書 | **M** | 1.15 | |
    | **9** | コミック | **M** | 1.15 | 新書判サイズに近い |
    | **0** | 単行本 | **L** | 1.30 | 一般的な四六判など |
    | **3** | 全集・双書 | **L** | 1.30 | |
    | **4** | ムック・その他 | **XL** | 1.45 | 雑誌扱い・大型本 |
    | **5** | 事典・辞典 | **XL** | 1.45 | |
    | **6** | 図鑑 | **XL** | 1.45 | |
    | **7** | 絵本 | **XL** | 1.45 | 規格外も多いが最大サイズとする |
2.  **キーワード・属性による二次判定**
    * Cコードが「0（単行本）」または取得不能な場合、タイトルや出版社名で補正を行う。
    * 条件: タイトルに「技術」「リファレンス」、出版社が「オライリー」等の場合。
    * 結果: **XLサイズ** (基準比 1.45 / 技術書・大型本)
3.  **ゆらぎ処理 (Noise Injection)**
    * 完全に数種類で分けてしまうと機械感が出てしまう。
    * 描画時に±1~2%のランダムな高低差を加え、有機的な並びを再現する。