# アプリケーション基本設計書：BookStack

## 1. コンセプト定義
* **アプリ名案:** BookStack
* **キャッチコピー:** あなたの知的生活を、美しく可視化する。
* **ターゲット:** 読書家、積読に悩む人、形から入りたいタイプの人、自分の知識の変遷を記録したい人。
* **コアバリュー:**
    1.  **所有感:** リアルな本棚のようなビジュアルで、集める楽しさを刺激する。
    2.  **達成感:** 読書量を可視化し、日々の積み重ねを実感させる。

## 2. 機能要件定義

### 【必須機能（MVP: Minimum Viable Product）】

1.  **蔵書登録機能**
    * **バーコードスキャン:** カメラでISBNコードを読み取り、書誌情報（タイトル、著者、表紙画像など）をAPIから取得して登録。
    * **キーワード検索:** タイトルや著者名での検索登録（スキャンできない場合）。
2.  **デジタル本棚機能（メイン画面）**
    * **背表紙表示:** 取得した表紙画像から、疑似的に「背表紙」を生成して並べる（※技術的工夫が必要）。
    * **本棚の整理:** カテゴリ別、著者別、読了日順などでの並べ替え。
    * **本の選択**: 本棚で長押しすると選択した本が拡大表示される。そのまま指を離したときに詳細画面に遷移。
3.  **読書記録・可視化機能**
    * **読書ステータス管理:** 「未読（積読）」「読書中」「読了」の3ステータス管理。
    * **読書ヒートマップ:** 読んだページ数や時間に応じてカレンダーの本が積み重なるようなビジュアルで表示。
    * **ページ数記録:** 「今日は◯ページまで読んだ」という進捗入力。

### 【追加機能（Ver.2以降）】

1.  **AIレコメンド機能**
    * Supabaseのベクトル検索 (`pgvector`) を活用。手持ちの本をベクトル化して比較し、「次に読むべき未読本」や「好みが近い未購入本」を提案する。
2.  **積読ビジュアライザー**
    * 「積読」ステータスの本だけを積み上げた「タワー」を表示し、高さで未読量を可視化（プレッシャーではなくユーモアのある表現）。
3.  **引用・メモ機能**
    * 気に入ったフレーズをOCR（文字認識）で取り込み、保存する機能。
4.  **シェア機能**
    * 他人の読了した本や読書記録を見る機能

---

## 3. UI/UXデザインの工夫（こだわりポイント）

「ずっと眺めていたくなる」「背表紙」を実現するための具体的アプローチ

### A. 疑似背表紙生成ロジック（技術的課題の解決）
通常の書籍API（Google Books APIやOpenBD）は「表紙（面）」の画像しか提供しません。「背表紙」の画像データは市場にほぼ存在しないため、以下のロジックで実装します。

1.  **色抽出:** 表紙画像の主要色（ドミナントカラー）を抽出。
2.  **生成:** その色をベースにした長方形を作成し、タイトル文字を縦書きで配置する。
3.  **厚み表現:** ページ数情報をもとに、本の「厚み（幅）」を可変させる（分厚い技術書は太く、新書は細く）。
    * *これにより、統一感がありつつリアリティのある本棚が作れます。*

### B. モチベーション維持の工夫
* **ヒートマップのゲーミフィケーション:**
    * 全く読まない日は「グレー」、読んだページ数に応じてカレンダーの日付の部分が本が積み重なるように表示される。
    * 「7日間連続読書」などでバッジ付与や、エフェクト表示（紙吹雪など）。
* **積読のポジティブ化:**
    * 積読を悪いこととせず、「知識の貯蔵庫」として表現。「次はどれを崩そうかな」と選ぶワクワク感を演出するUI。

---

## 4. 技術スタック案（推奨構成）

[書籍データAPIの選定理由](docs/ReasonChoosingAPI.md)

| 区分 | 技術要素 | 選定理由 |
| :--- |:--- |:--- |
| **アプリ開発 (Frontend)** | **Jetpack Compose (Android)** | 宣言的UIは本棚のグリッド描画やアニメーションと相性が良い。仕事で使うのでその練習 |
| **バックエンド (BaaS)** | **Supabase** (PostgreSQL) | **SQL学習と将来性重視。**<br>1. **SQLスキル:** AWS等でも汎用的に使えるRDB設計・SQL操作を習得するため。<br>2. **AI親和性:** ベクトル検索機能 (`pgvector`) が標準搭載されており、AIレコメンド機能の実装が容易。<br>3. **コスト:** 無料枠でRDBが利用可能。 |
| **プッシュ通知** | **Firebase (FCM)** | Supabaseにはプッシュ通知機能がないため、Android標準かつデファクトスタンダードであるFCMのみを部分的に採用。 |
| **書籍データAPI** | **OpenBD** (優先) + **Google Books API** (予備) | **ハイブリッド構成を採用。**<br>1. **OpenBD:** 高画質な書影取得と高速なレスポンスのため最優先で使用。<br>2. **Google Books:** OpenBDでヒットしない古書や洋書、ページ数情報が欠落している場合の補完として使用。 |

## 補足：書籍データの取得戦略

アプリの独自性である「背表紙の厚み」を再現するため、以下の優先順位でデータをマージする。

1.  **ISBNスキャン**
2.  **OpenBD問い合わせ**
    * 成功 → タイトル、著者、書影URL、ページ数を取得。
    * 失敗(データなし) → Google Booksへ。
3.  **Google Books問い合わせ** (OpenBD失敗時)
    * 成功 → 必要な情報を取得。画質はOpenBDより劣る可能性がある点を許容。
4.  **データ補正 (重要)**
    * 両方のAPIで「ページ数」が取得できなかった場合、デフォルト値（例: `200`）を一時的に設定し、詳細画面でユーザーによる編集を可能にする。

---

## 5. データベース設計（Supabase / PostgreSQL）

NoSQL (Collection) ではなく、RDB (Table) 形式で設計。
※AI機能を見据え、`books`テーブルにベクトル保存用の列を定義。

**📊 ER図:** [詳細なER図とリレーションシップの説明](./diagrams/erd.md)

### `profiles` テーブル (ユーザー情報)
Supabase Authの`users`テーブルと連動させる公開用テーブル。

| カラム名 | データ型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | **PK**, FK | AuthユーザーIDと紐付け |
| `display_name` | `TEXT` | | 表示名 |
| `avatar_url` | `TEXT` | | アイコン画像URL |
| `created_at` | `TIMESTAMPTZ` | | 作成日時 |

### `books` テーブル (所持本データ)

| カラム名 | データ型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | **PK** | 自動生成ID (v4) |
| `user_id` | `UUID` | **FK** | 所有ユーザー (`profiles.id`) |
| `isbn` | `TEXT` | NOT NULL | ISBNコード (13桁) |
| `title` | `TEXT` | NOT NULL | タイトル |
| `authors` | `JSONB` | | 著者リスト (配列で保存) |
| `cover_url` | `TEXT` | | 表紙画像URL |
| `spine_color` | `TEXT` | | 抽出した背表紙用の色コード (Hex) |
| `size_type` | `TEXT` | | 判型 (S/M/L/XL) ※Cコード判定結果 |
| `page_count` | `INTEGER` | | 総ページ数 |
| `status` | `TEXT` | | `unread`, `reading`, `completed` |
| `current_page` | `INTEGER` | | 現在読んでいるページ数 |
| `embedding` | `VECTOR(1536)` | | **AI用: 本の内容・特徴ベクトル** |
| `added_at` | `TIMESTAMPTZ` | | 登録日 |
| `completed_at` | `TIMESTAMPTZ` | | 読了日 |

### `reading_logs` テーブル (ヒートマップ用)

| カラム名 | データ型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | **PK** | 自動生成ID |
| `user_id` | `UUID` | **FK** | ユーザーID |
| `book_id` | `UUID` | **FK** | 本ID (`books.id`) |
| `read_date` | `DATE` | NOT NULL | 読んだ日付 |
| `pages_read` | `INTEGER` | | その日に読んだページ数 |
| `duration_mins` | `INTEGER` | | (オプション) 読書時間(分) |